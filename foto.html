<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Fotografia del mes</title>
  <link rel="icon" href="assets/icons/astromallorca.png">

  <style>
    :root{
      --bg:#ffffff;
      --text:#111111;
      --muted:rgba(0,0,0,.65);
      --border:rgba(0,0,0,.18);
      --card: rgba(0,0,0,0.03);
    }
    body.nocturn{
      --bg:#000000;
      --text:#ff2a2a;
      --muted:rgba(255,42,42,.75);
      --border:rgba(255,42,42,.35);
      --card: rgba(255,42,42,0.08);
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      background:var(--bg);
      color:var(--text);
      padding: 18px 16px 28px;
    }

    a.back{
      color:var(--text);
      text-decoration:none;
      display:inline-block;
      margin: 6px 0 8px;
      font-size: 18px;
    }

h1{
  margin: 0 0 6px;
  font-size: 34px;
  letter-spacing: -0.02em;
  text-align: center;          /* ‚úÖ */
}

.sub{
  margin: 2px 0 16px;
  color: var(--text);     /* negre en dia, vermell en nocturn */
  font-size: 18px;        /* una mica m√©s gran */
  font-weight: 500;       /* lleugerament m√©s marcat */
  text-align: center;
}

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 14px;
    }
.author{
  margin-top: 12px;
  text-align: center;
  font-size: 18px;
  font-weight: 600;
}

.info-card{
  margin-top: 12px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 12px 12px;
}

.tech-line{
  font-size: 16px;
  line-height: 1.35;
}

.lloc-line,
.credits-line{
  margin-top: 10px;
  font-size: 16px;
  line-height: 1.35;
}

.lloc-line b,
.credits-line b{
  font-weight: 700;
}

    img{
      width:100%;
      height:auto;
      border-radius: 16px;
      display:block;
    }
  </style>
</head>
<body>

  <a class="back" href="index.html">‚Üê Tornar</a>
<h1 id="pageTitle">Fotografia del mes</h1>
<p class="sub" id="subtitle">‚Äî</p>

<div class="card">
  <img id="photo" alt="Foto del mes">
  <div id="author" class="author" style="display:none;"></div>

  <div id="infoCard" class="info-card" style="display:none;">
    <div id="techLine" class="tech-line"></div>
    <div id="llocLine" class="lloc-line"></div>
    <div id="creditsLine" class="credits-line"></div>
  </div>
</div>

<script>
  // Hereta mode nocturn de l'app
  try{
    const apply = () => {
      const isNocturn = localStorage.getItem("nocturn") === "1";
      document.body.classList.toggle("nocturn", isNocturn);
    };
    apply();
    window.addEventListener("storage", (e) => {
      if (e.key === "nocturn") apply();
    });
  }catch(e){}

  // Mes des de la URL
  const params = new URLSearchParams(location.search);
  const ym = params.get("ym") || "2026-01"; // YYYY-MM

  const BASE_SHEETS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSWf6OL8LYzMsBPuxvI_h4s9-0__hru3hWK9D2ewyccoku9ndl2VhZ0GS8P9uEigShJEehsy2UktnY2/pub";
  const SHEET_FOTOS_MES = `${BASE_SHEETS}?output=csv&gid=0`;

  function detectDelimiter(text){
    const firstLine = (text.split(/\r?\n/).find(l => l.trim()) || "");
    return (firstLine.match(/;/g) || []).length > (firstLine.match(/,/g) || []).length ? ";" : ",";
  }

  function parseCSV(text){
    const delimiter = detectDelimiter(text);
    const rows = [];
    let row=[], cur="", inQuotes=false;

    for (let i=0;i<text.length;i++){
      const c=text[i], n=text[i+1];
      if (c === '"' && inQuotes && n === '"'){ cur+='"'; i++; continue; }
      if (c === '"'){ inQuotes=!inQuotes; continue; }
      if (c === delimiter && !inQuotes){ row.push(cur); cur=""; continue; }
      if ((c === "\n" || c === "\r") && !inQuotes){
        if (cur || row.length){ row.push(cur); rows.push(row); }
        row=[]; cur="";
        if (c === "\r" && n === "\n") i++;
        continue;
      }
      cur+=c;
    }
    if (cur || row.length){ row.push(cur); rows.push(row); }
    return rows;
  }

  function normalizeHeader(h){
    return (h||"").trim().toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[\s-]+/g,"_")
      .replace(/[^a-z0-9_]/g,"");
  }

  function rowsToObjects(rows){
    if (!rows.length) return [];
    const header = rows[0].map(normalizeHeader);
    return rows.slice(1)
      .filter(r => r.some(x => (x||"").trim() !== ""))
      .map(r => {
        const o={};
        header.forEach((h,i)=>o[h]=(r[i]??"").trim());
        return o;
      });
  }

  async function loadFotosMes(){
    const r = await fetch(SHEET_FOTOS_MES, { cache:"no-store" });
    if (!r.ok) throw new Error("No puc carregar fotos");
    const t = await r.text();
    return rowsToObjects(parseCSV(t));
  }

  (async()=>{
    // fallback
    document.getElementById("photo").src = `assets/months/2026/${ym}.png`;

    try{
      const rows = await loadFotosMes();
      const f =
        rows.find(o => (o.any_mes||"").trim() === ym) ||
        rows.find(o => (o.any_mes||"").trim() === `${ym.slice(5,7)}-${ym.slice(0,4)}`);

document.getElementById("subtitle").textContent =
  (f?.titol || "").trim() || "‚Äî";

if (f?.imatge) document.getElementById("photo").src = f.imatge;

// === AUTOR (centrat sota la foto) ===
const autor = (f?.autor || "").trim();
const authorEl = document.getElementById("author");
if (authorEl){
  if (autor){
    authorEl.textContent = autor;
    authorEl.style.display = "block";
  }else{
    authorEl.style.display = "none";
  }
}

// === REQUADRE DADES FOTO (nom√©s si hi ha dades) ===
const clean = (v) => (v ?? "").toString().trim();

const camera   = clean(f?.camera);
const objectiu = clean(f?.objectiu);
const exposicio= clean(f?.exposicio);
const isoVal   = clean(f?.iso);
const fVal     = clean(f?.f);

const lloc  = clean(f?.lloc);
const credits = clean(f?.credits ?? f?.credit);

const tech = [];
if (camera)   tech.push(`üì∑ ${camera}`);
if (objectiu) tech.push(`üî≠ ${objectiu}`);
if (exposicio)tech.push(`‚è± ${exposicio}`);
if (isoVal)   tech.push(`ISO ${isoVal}`);
if (fVal)     tech.push(`f/${fVal}`);

const hasInfoCard = tech.length || lloc || credits;

const infoCard = document.getElementById("infoCard");
const techLine = document.getElementById("techLine");
const llocLine = document.getElementById("llocLine");
const creditsLine = document.getElementById("creditsLine");

if (infoCard){
  if (hasInfoCard){
    // l√≠nia t√®cnica
    if (techLine){
      techLine.innerHTML = tech.length ? tech.join(" ¬∑ ") : "";
      techLine.style.display = tech.length ? "block" : "none";
    }

    // lloc
    if (llocLine){
      llocLine.innerHTML = lloc ? `<b>Lloc:</b> ${lloc}` : "";
      llocLine.style.display = lloc ? "block" : "none";
    }

    // cr√®dits
    if (creditsLine){
      creditsLine.innerHTML = credits ? `<b>Cr√®dits:</b> ${credits}` : "";
      creditsLine.style.display = credits ? "block" : "none";
    }

    infoCard.style.display = "block";
  }else{
    infoCard.style.display = "none";
  }
}

    }catch(e){
      console.warn(e);
    }
  })();
</script>

</body>
</html>
