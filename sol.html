<!doctype html>
<html lang="ca">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Sol</title>

<style>
  :root{
    /* DIA */
    --bg:#ffffff;
    --text:#111111;
    --muted:rgba(0,0,0,.65);
    --border:rgba(0,0,0,.18);
    --card: rgba(0,0,0,0.03);
  }

  /* NOCTURN (heretat de l'app: body.nocturn) */
  body.nocturn{
    --bg:#000000;
    --text:#ff2a2a;
    --muted:rgba(255,42,42,.75);
    --border:rgba(255,42,42,.35);
    --card: rgba(255,42,42,0.08);
  }

  body{
    margin:0;
    font-family: system-ui, -apple-system, Segoe UI, sans-serif;
    background: var(--bg);
    color: var(--text);
    padding:16px;
  }

  a{ color:var(--text); text-decoration:none; }
  a:hover{ text-decoration:underline; }

  .wrap{ max-width:720px; margin:0 auto; }

  h1{
    margin: 8px 0 6px;
    font-size: 34px;
    font-weight: 800;
    letter-spacing: .2px;
  }

  .meta{
    color: var(--muted);
    margin: 0 0 12px;
    font-size: 14px;
  }

  .hero{
    display:block;
    margin: 8px 0 14px;
    max-width: 100%;
    height: auto;
  }

  .card{
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 14px;
    margin: 12px 0;
  }

  /* KPI */
  .kpi{
    white-space: pre-line;
    font-size: 18px;
    line-height: 1.2;
  }
  .kpi b{ font-weight: 800; }

  /* Llista d'hores (estil taula, com Planetes) */
  .list{
    display:flex;
    flex-direction:column;
    gap: 0;
    margin: 0;
    padding: 0;
  }
  .row{
    display:grid;
    grid-template-columns: 18px 1fr auto;
    align-items:center;
    gap: 10px;
    padding: 12px 6px;
    border-bottom: 1px solid var(--border);
    font-size: 18px;
  }
  .row:last-child{ border-bottom: 0; }

  .dot{
    width: 14px;
    height: 14px;
    border-radius: 999px;
    outline: 1px solid var(--border);
  }
  .label{
    min-width: 0;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .time{
    text-align:right;
    font-weight: 800;
    letter-spacing: .3px;
    font-variant-numeric: tabular-nums;
    white-space: nowrap;
  }

  .err{
    margin-top: 12px;
    padding: 10px 12px;
    border: 1px solid var(--border);
    border-radius: 12px;
    font-size: 14px;
    color: var(--text);
    background: var(--card);
  }
  /* Centrat general */
.center{
  text-align: center;
}

/* Data més gran */
.meta.big{
  font-size: 18px;
  margin-bottom: 14px;
}

/* Imatge centrada */
.center-img{
  display: block;
  margin: 12px auto 16px;
}

/* KPI: valors alineats a la dreta */
.kpi{
  display: grid;
  grid-template-columns: 1fr auto;
  row-gap: 8px;
  column-gap: 12px;
}

.kpi b{
  font-weight: 700;
  text-align: left;
}

.kpi span{
  text-align: right;
  font-weight: 800;
  font-variant-numeric: tabular-nums;
}

</style>
</head>

<body>
<div class="wrap">
  <a href="#" id="back">← Tornar</a>

  <h1 class="center">El Sol avui</h1>
<div class="meta center big" id="meta"></div>

  <img class="hero center-img" src="assets/icons/sun.png" alt="Sol">

  <div class="card">
    <div class="kpi" id="kpi">Carregant…</div>
  </div>

  <div class="card">
    <div class="list" id="list"></div>
    <div class="err" id="err" style="display:none"></div>
  </div>
</div>


  <!-- astronomy-engine (local) -->
  <script src="assets/js/astronomy.browser.min.js"></script>

  <script>
    // Debug curt (el pots llevar després)
    console.log("Astronomy loaded?", typeof Astronomy, Astronomy?.SearchRiseSet);

    const p = new URLSearchParams(location.search);

    const dateStr = p.get("date"); // "YYYY-MM-DD"
    const lat  = Number(p.get("lat"));
    const lon  = Number(p.get("lon"));
    const elev = Number(p.get("elev"));

    // Fallback (Palma aprox) si no arriba res
    const observer = {
      latitude:  Number.isFinite(lat) ? lat : 39.5696,
      longitude: Number.isFinite(lon) ? lon : 2.6502,
      elevation: Number.isFinite(elev) ? elev : 0
    };

    // ✅ Astronomy Engine necessita un Observer real
    const obs = new Astronomy.Observer(observer.latitude, observer.longitude, observer.elevation);

    function parseISODateLocal(iso){
      if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return new Date();
      const [y,m,d] = iso.split("-").map(Number);
      return new Date(y, m-1, d, 0, 0, 0);
    }

    const day0 = parseISODateLocal(dateStr);

    try {
      document.getElementById("back").addEventListener("click", (e) => {
        e.preventDefault();
        window.history.back();
      });

      function fmtHM(date){
        if (!date) return "--:--";
        return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", hour12: false });
      }

      function fmtDur(ms){
        if (!Number.isFinite(ms) || ms < 0) return "—";
        const totalMin = Math.round(ms / 60000);
        const h = Math.floor(totalMin / 60);
        const m = totalMin % 60;
        return `${h}h ${String(m).padStart(2,"0")}m`;
      }

      function tryRiseSet(direction, startDate){
        try{
          const t0 = Astronomy.MakeTime(startDate);
          // SearchRiseSet retorna AstroTime
          const t  = Astronomy.SearchRiseSet(Astronomy.Body.Sun, obs, direction, t0, 2, 0);
          return (t && t.date) ? new Date(t.date.getTime()) : null;
        }catch(e){
          console.warn("SearchRiseSet error:", e);
          return null;
        }
      }

      function tryAltitudeCrossing(altDeg, direction, startDate){
        try{
          const t0 = Astronomy.MakeTime(startDate);
          // SearchAltitude retorna AstroTime
          const t  = Astronomy.SearchAltitude(Astronomy.Body.Sun, obs, direction, t0, 2, altDeg);
          return (t && t.date) ? new Date(t.date.getTime()) : null;
        }catch(e){
          console.warn("SearchAltitude error:", e);
          return null;
        }
      }

      function earthSunDistanceKm(date){
        try{
          const t = Astronomy.MakeTime(date);
          const v = Astronomy.GeoVector(Astronomy.Body.Sun, t, true);
          const rAU = Math.sqrt(v.x*v.x + v.y*v.y + v.z*v.z);
          const AU_KM = (typeof Astronomy.AU_KM === "number") ? Astronomy.AU_KM : 149597870.7;
          return rAU * AU_KM;
        }catch(e){
          return NaN;
        }
      }

      function julianDay(date){
  try{
    const t = Astronomy.MakeTime(date);
    // JD clàssic: 2451545.0 és el JD de J2000.0 (2000-01-01 12:00 TT aprox)
    return 2451545.0 + t.ut;
  }catch(e){
    return NaN;
  }
}


      // ===== CÀLCULS PER AL DIA =====
      const startMorning = new Date(day0.getFullYear(), day0.getMonth(), day0.getDate(), 0, 0, 0);
      const startEvening = new Date(day0.getFullYear(), day0.getMonth(), day0.getDate(), 12, 0, 0);

      const astroDawn   = tryAltitudeCrossing(-18, +1, startMorning);
      const nauticDawn  = tryAltitudeCrossing(-12, +1, startMorning);

      // Hora blava = -6°, Hora daurada = -4°
      const blueAM      = tryAltitudeCrossing(-6, +1, startMorning);
      const goldenAM    = tryAltitudeCrossing(-4, +1, startMorning);

      const sunrise     = tryRiseSet(+1, startMorning);

      // ✅ MIGDIA SOLAR + ELEVACIÓ MÀXIMA
      let solarNoon = null;
      let maxAlt = NaN;

      try {
        // Migdia solar = hora-angle 0 (pas pel meridià)
        const evt = Astronomy.SearchHourAngle(
          Astronomy.Body.Sun,
          obs,
          0,            // hora-angle 0h
          startMorning, // Date
          +1            // endavant
        );

        // evt és AstroEvent { time: AstroTime, hor: { altitude, ... } }
        solarNoon = (evt && evt.time && evt.time.date) ? new Date(evt.time.date.getTime()) : null;
        maxAlt    = (evt && evt.hor && Number.isFinite(evt.hor.altitude)) ? evt.hor.altitude : NaN;
      } catch (e) {
        console.warn("SearchHourAngle (migdia solar) error:", e);
      }

      const goldenPM    = tryAltitudeCrossing(-4, -1, startEvening);
      const sunset      = tryRiseSet(-1, startEvening);
      const bluePM      = tryAltitudeCrossing(-6, -1, startEvening);

      const nauticDusk  = tryAltitudeCrossing(-12, -1, startEvening);
      const astroDusk   = tryAltitudeCrossing(-18, -1, startEvening);

      const daylightMs = (sunrise && sunset) ? (sunset.getTime() - sunrise.getTime()) : NaN;

      const distKm = earthSunDistanceKm(solarNoon || startMorning);
      const distMillionKm = distKm / 1e6;

      const jd = julianDay(startMorning);

      // ===== PINTAR =====
      const kpiEl = document.getElementById("kpi");
      kpiEl.innerHTML =
        `<b>Dia julià:</b> ${Number.isFinite(jd) ? jd.toFixed(5) : "—"}\n` +
        `<b>Hores de llum:</b> ${fmtDur(daylightMs)}\n` +
        `<b>Elevació màxima:</b> ${Number.isFinite(maxAlt) ? maxAlt.toFixed(1) + "°" : "—"}\n` +
        `<b>Distància del sol:</b> ${Number.isFinite(distMillionKm) ? distMillionKm.toFixed(3) + " M km" : "—"}`;

      function fmtDMYFromISO(iso){
  if (!iso || !/^\d{4}-\d{2}-\d{2}$/.test(iso)) return "";
  const [y,m,d] = iso.split("-");
  return `${d}-${m}-${y}`;
}
function weekdayCAT(date){
  const dies = ["Dg","Dl","Dt","Dc","Dj","Dv","Ds"];
  return dies[date.getDay()];
}

const dmy =
  fmtDMYFromISO(dateStr) ||
  `${String(day0.getDate()).padStart(2,"0")}-${String(day0.getMonth()+1).padStart(2,"0")}-${day0.getFullYear()}`;

document.getElementById("meta").textContent = `${weekdayCAT(day0)} · ${dmy}`;


      const list = document.getElementById("list");

      const items = [
        { label: "Crepuscul astronòmic", time: astroDawn,  color: "#0b1d63" },
        { label: "Crepuscul nàutic",     time: nauticDawn, color: "#1533ff" },
        { label: "Hora Blava",           time: blueAM,     color: "#00c9ff" },
        { label: "Hora dorada",          time: goldenAM,   color: "#ffb13a" },
        { label: "Sortida",              time: sunrise,    color: "#ffff4a" },
        { label: "Migdia solar",         time: solarNoon,  color: "#f2ffb0" },
        { label: "Hora dorada",          time: goldenPM,   color: "#ffb13a" },
        { label: "Posta de sol",         time: sunset,     color: "#c67816" },
        { label: "Hora Blava",           time: bluePM,     color: "#00c9ff" },
        { label: "Crepuscul nàutic",     time: nauticDusk, color: "#1533ff" },
        { label: "Crepuscul astronòmic", time: astroDusk,  color: "#0b1d63" },
      ];

      items.forEach(it => {
        const row = document.createElement("div");
        row.className = "row";

        const dot = document.createElement("div");
        dot.className = "dot";
        dot.style.background = it.color;

        const lab = document.createElement("div");
        lab.className = "label";
        lab.textContent = it.label + ":";

        const tm = document.createElement("div");
        tm.className = "time";
        tm.textContent = fmtHM(it.time);

        row.appendChild(dot);
        row.appendChild(lab);
        row.appendChild(tm);
        list.appendChild(row);
      });

      const missing = items.filter(x => !x.time).map(x => x.label);
      if (missing.length){
        const err = document.getElementById("err");
        err.style.display = "block";
        err.textContent = "Algunes hores no s'han pogut calcular. Falta: " + missing.join(", ");
      }

    } catch (e) {
      console.error("Error calculant el Sol:", e);
      const err = document.getElementById("err");
      err.style.display = "block";
      err.textContent = "Error intern calculant efemèrides. Mira la consola.";
    }
    // Hereta el mode nocturn de l'app (localStorage) i escolta canvis
try{
  const apply = () => {
    const isNocturn = localStorage.getItem("nocturn") === "1";
    document.body.classList.toggle("nocturn", isNocturn);
  };
  apply();
  window.addEventListener("storage", (e) => {
    if (e.key === "nocturn") apply();
  });
}catch(e){}

  </script>

</body>
</html>
